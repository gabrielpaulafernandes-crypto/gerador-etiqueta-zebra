<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zebra Label Generator | CD300</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0086ff; /* Azul Magalu */
            --primary-hover: #006ecf;
            --success-color: #00a650;
            --dark-text: #2c3e50;
            --light-bg: #f3f6f8;
            --card-bg: #ffffff;
            --border-radius: 12px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
            margin: 0;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: var(--card-bg);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 750px;
            box-sizing: border-box;
        }
        
        /* Header */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        h2 {
            margin: 0;
            color: var(--primary-color);
            font-weight: 600;
            letter-spacing: -0.5px;
        }
        
        h3 {
            font-size: 16px;
            color: #555;
            margin-top: 0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* Se√ß√µes */
        .section-box {
            background-color: #fff;
            border: 1px solid #e1e4e8;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 30px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .section-box:hover {
            border-color: #d1d5db;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }

        .section-box.batch {
            background: linear-gradient(to bottom right, #f8fbff, #fff);
            border-color: #cce0ff;
        }

        /* Inputs e Selects */
        .input-group { margin-bottom: 20px; }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 13px;
            color: #4a5568;
        }

        input[type="text"], input[type="file"], select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
            background-color: #fff;
            transition: all 0.3s;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        input:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 134, 255, 0.15);
        }

        /* Badges */
        .badge {
            background-color: #edf2f7;
            color: #4a5568;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .badge-blue { background-color: #ebf8ff; color: var(--primary-color); }

        /* Bot√µes */
        .btn-container { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        
        button {
            flex: 1;
            padding: 14px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            color: white;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        button:active:not(:disabled) { transform: translateY(0); }

        .btn-print { background-color: var(--success-color); }
        .btn-print:hover { background-color: #009146; }
        
        .btn-process { background-color: var(--primary-color); }
        .btn-process:hover { background-color: var(--primary-hover); }
        
        .btn-download { background-color: #718096; }
        .btn-download:hover { background-color: #4a5568; }

        button:disabled { background-color: #cbd5e0; cursor: not-allowed; box-shadow: none; transform: none; }

        /* Preview e Rodap√© */
        .preview-area {
            text-align: center;
            margin-top: 20px;
            border: 2px dashed #e2e8f0;
            border-radius: var(--border-radius);
            padding: 20px;
            background: #f8fafc;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #preview-img {
            max-width: 100%;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        textarea {
            width: 100%;
            height: 60px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 8px;
            padding: 10px;
            font-size: 11px;
            color: #718096;
            resize: none;
            outline: none;
        }

        .helper-text { font-size: 12px; color: #718096; margin-top: 5px; }
        .hidden { display: none; }

        /* Footer Assinatura */
        footer {
            margin-top: 40px;
            text-align: center;
            font-size: 12px;
            color: #a0aec0;
            border-top: 1px solid #e2e8f0;
            padding-top: 20px;
            width: 100%;
        }
        
        footer strong { color: var(--primary-color); font-weight: 600; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2>üñ®Ô∏è Gerador Zebra CD300</h2>
    </header>

    <div class="input-group">
        <label>Configura√ß√£o Global do Colaborador:</label>
        <select id="tipoColaborador" onchange="toggleCampos()">
            <option value="efetivo">Efetivo Magalu (Somente ID)</option>
            <option value="temporario">Tempor√°rio (ID + Nome)</option>
        </select>
    </div>

    <div class="section-box">
        <h3>
            <span>Individual</span>
            <span class="badge">√önico</span>
        </h3>
        
        <div class="input-group">
            <label>Tamanho do QR Code:</label>
            <select id="tamanhoQR_Indiv" onchange="gerarIndividual()">
                <option value="2">Muito Pequeno (~1.0 cm)</option>
                <option value="3">Pequeno Padr√£o (~1.5 cm)</option>
                <option value="4">Pequeno Plus (~2.0 cm)</option>
                <option value="5">M√©dio (~2.5 cm)</option>
                <option value="6">M√©dio Plus (~3.0 cm)</option>
                <option value="8" selected>Grande (~4.0 cm)</option>
                <option value="10">Extra Grande (~5.0 cm)</option>
            </select>
        </div>

        <div class="input-group">
            <label>Dados para Impress√£o:</label>
            <input type="text" id="idFunc" placeholder="Digite o ID / Matr√≠cula" onkeyup="gerarIndividual()">
            <input type="text" id="nomeFunc" class="hidden" placeholder="Digite o Nome Completo" onkeyup="gerarIndividual()" style="margin-top:10px;">
        </div>

        <div class="btn-container">
            <button class="btn-print" id="btnPrintSingle" onclick="imprimirUnico()" disabled>
                üñ®Ô∏è Imprimir Etiqueta
            </button>
        </div>
    </div>

    <div class="section-box batch">
        <h3>
            <span>Em Lote (CSV)</span>
            <span class="badge badge-blue">M√∫ltiplos</span>
        </h3>
        
        <div class="input-group">
            <label>Tamanho para o Lote:</label>
            <select id="tamanhoQR_Lote">
                <option value="2">Muito Pequeno (~1.0 cm)</option>
                <option value="3">Pequeno Padr√£o (~1.5 cm)</option>
                <option value="4">Pequeno Plus (~2.0 cm)</option>
                <option value="5">M√©dio (~2.5 cm)</option>
                <option value="6">M√©dio Plus (~3.0 cm)</option>
                <option value="8" selected>Grande (~4.0 cm)</option>
                <option value="10">Extra Grande (~5.0 cm)</option>
            </select>
        </div>

        <div class="input-group">
            <label for="csvFile">Upload do Arquivo CSV:</label>
            <input type="file" id="csvFile" accept=".csv">
            <div class="helper-text">Padr√£o: Apenas ID (Coluna A) ou ID,Nome (Colunas A,B).</div>
        </div>

        <div class="btn-container">
            <button class="btn-process" onclick="processarCSV()">‚öôÔ∏è Processar CSV</button>
        </div>
        
        <div class="btn-container">
            <button class="btn-print" id="btnPrintBatch" onclick="imprimirLoteVisual()" disabled>üñ®Ô∏è Imprimir Lote</button>
            <button class="btn-download" id="btnDownload" onclick="baixarArquivoZPL()" disabled>üíæ Baixar .ZPL</button>
        </div>
    </div>

    <div class="preview-area">
        <p id="msg-status" class="helper-text">A visualiza√ß√£o da etiqueta aparecer√° aqui.</p>
        <img id="preview-img" alt="Preview" />
    </div>

    <textarea id="saidaZPL" readonly placeholder="C√≥digo ZPL gerado (Raw Data)..."></textarea>

    <footer>
        Desenvolvido por <strong>Gabriel Fernandes CD300</strong>
    </footer>
</div>

<script>
    // --- L√ìGICA DO SISTEMA ---
    let dadosCSV = [];

    function toggleCampos() {
        const tipo = document.getElementById('tipoColaborador').value;
        const inputNome = document.getElementById('nomeFunc');
        if (tipo === 'temporario') {
            inputNome.classList.remove('hidden');
        } else {
            inputNome.classList.add('hidden');
        }
        document.getElementById('saidaZPL').value = "";
    }

    function criarZPL(id, nome, tamanho, tipo) {
        let conteudoQR = "";
        id = id ? id.trim() : "";
        nome = nome ? nome.trim() : "";

        if (tipo === 'temporario') {
            if (!nome) return null;
            conteudoQR = `ID:${id} Nome:${nome}`;
        } else {
            conteudoQR = `${id}`;
        }
        // Margem Topo ajustada para 5 pontos
        return `^XA^FO50,5^BQN,2,${tamanho}^FDQA,${conteudoQR}^FS^XZ`;
    }

    function gerarIndividual() {
        const tipo = document.getElementById('tipoColaborador').value;
        const tamanho = document.getElementById('tamanhoQR_Indiv').value;
        const id = document.getElementById('idFunc').value;
        const nome = document.getElementById('nomeFunc').value;
        const btnPrint = document.getElementById('btnPrintSingle');

        if (!id) {
            btnPrint.disabled = true;
            return;
        }

        const zpl = criarZPL(id, nome, tamanho, tipo);
        
        if (zpl) {
            document.getElementById('saidaZPL').value = zpl;
            btnPrint.disabled = false;
            atualizarPreview(zpl, "Visualiza√ß√£o Individual");
        }
    }

    function processarCSV() {
        const fileInput = document.getElementById('csvFile');
        const tipo = document.getElementById('tipoColaborador').value;
        const tamanho = document.getElementById('tamanhoQR_Lote').value;
        const btnDownload = document.getElementById('btnDownload');
        const btnBatch = document.getElementById('btnPrintBatch');

        if (fileInput.files.length === 0) {
            alert("Por favor, selecione um arquivo CSV.");
            return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = function(e) {
            const texto = e.target.result;
            const linhas = texto.split(/\r?\n/);
            
            let zplFinal = "";
            dadosCSV = [];
            let count = 0;
            let primeiroZPL = "";

            linhas.forEach(linha => {
                if (!linha.trim()) return;
                const colunas = linha.split(/[,;]/);
                const id = colunas[0];
                const nome = colunas[1] || "";

                const zplItem = criarZPL(id, nome, tamanho, tipo);
                
                if (zplItem) {
                    zplFinal += zplItem + "\n";
                    dadosCSV.push({ zpl: zplItem, id: id });
                    if (count === 0) primeiroZPL = zplItem;
                    count++;
                }
            });

            if (count > 0) {
                document.getElementById('saidaZPL').value = zplFinal;
                btnDownload.disabled = false;
                btnBatch.disabled = false;
                btnBatch.innerHTML = `üñ®Ô∏è Imprimir Lote (${count})`;
                alert(`${count} etiquetas processadas com sucesso!`);
                atualizarPreview(primeiroZPL, "Amostra do Lote (1¬™ Etiqueta)");
            } else {
                alert("O arquivo CSV parece estar vazio ou inv√°lido.");
            }
        };
        reader.readAsText(file);
    }

    function getLabelaryUrl(zpl) {
        const density = 8;
        const width = 3; 
        const height = 2; 
        const zplEncoded = encodeURIComponent(zpl);
        return `https://api.labelary.com/v1/printers/${density}dpmm/labels/${width}x${height}/0/${zplEncoded}`;
    }

    function atualizarPreview(zpl, textoStatus) {
        const img = document.getElementById('preview-img');
        const status = document.getElementById('msg-status');
        
        status.innerText = "Carregando pr√©-visualiza√ß√£o...";
        status.style.display = 'block';
        img.style.display = 'none';

        img.src = getLabelaryUrl(zpl);
        img.onload = function() {
            img.style.display = 'block';
            status.innerText = textoStatus;
        }
        img.onerror = function() { status.innerText = "Erro ao carregar imagem do servidor."; }
    }

    function imprimirUnico() {
        const imgSource = document.getElementById('preview-img').src;
        if (imgSource) abrirJanelaImpressao([imgSource]);
    }

    function imprimirLoteVisual() {
        if (dadosCSV.length === 0) return;
        if (dadosCSV.length > 50 && !confirm(`Aten√ß√£o: Gerar ${dadosCSV.length} imagens pode demorar alguns segundos. Deseja continuar?`)) return;
        const urlsImagens = dadosCSV.map(item => getLabelaryUrl(item.zpl));
        abrirJanelaImpressao(urlsImagens);
    }

    function abrirJanelaImpressao(listaUrls) {
        const printWindow = window.open('', '_blank', 'width=600,height=700');
        let htmlImagens = "";
        listaUrls.forEach(url => {
            htmlImagens += `<div class="label-container"><img src="${url}" loading="lazy" /></div>`;
        });

        printWindow.document.write(`
            <html>
                <head>
                    <title>Impress√£o Zebra</title>
                    <style>
                        body { margin: 0; padding: 0; background: #fff; }
                        .label-container { 
                            width: 100%; 
                            display: flex; 
                            justify-content: flex-start; 
                            align-items: flex-start; 
                            padding-top: 5px; 
                            page-break-after: always; 
                            break-after: page; 
                        }
                        img { max-width: 100%; height: auto; }
                        @media print { 
                            @page { margin: 0; size: auto; } 
                            body { margin: 0; } 
                            .label-container { page-break-after: always; } 
                            .label-container:last-child { page-break-after: auto; } 
                        }
                    </style>
                </head>
                <body>
                    ${htmlImagens}
                    <script>
                        setTimeout(() => { window.print(); }, ${listaUrls.length > 10 ? 2500 : 1000});
                    <\/script>
                </body>
            </html>
        `);
        printWindow.document.close();
    }

    function baixarArquivoZPL() {
        const conteudo = document.getElementById('saidaZPL').value;
        if (!conteudo) return;
        const blob = new Blob([conteudo], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `etiquetas_${new Date().toISOString().slice(0,10)}.zpl`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }
</script>

</body>
</html>